# ========================================
# GetInMotion — Staging Nginx Configuration
# Host-level reverse proxy (installed directly on the server, NOT in Docker)
#
# Prerequisites:
#   sudo apt install -y nginx certbot python3-certbot-nginx
#
# To install:
#   sudo cp nginx.conf /etc/nginx/sites-available/telar-staging
#   sudo ln -s /etc/nginx/sites-available/telar-staging /etc/nginx/sites-enabled/telar-staging
#   sudo rm -f /etc/nginx/sites-enabled/default
#   sudo nginx -t && sudo systemctl reload nginx
#
# SSL certs (single SAN cert covering all staging subdomains):
#   sudo certbot --nginx \
#     -d stage-api.telar.co \
#     -d stage-artisans.telar.co \
#     -d stage-marketplace.telar.co \
#     -d stage-agents.telar.co \
#     -d stage-payment.telar.co
# ========================================

# ----------------------------------------
# API (NestJS) — stage-api.telar.co → :3040
# ----------------------------------------
server {
    listen 80;
    server_name stage-api.telar.co;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name stage-api.telar.co;

    ssl_certificate     /etc/letsencrypt/live/stage-api.telar.co/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/stage-api.telar.co/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass         http://127.0.0.1:3040;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
        proxy_read_timeout 60s;
    }
}

# ----------------------------------------
# Artisans Web (React) — stage-artisans.telar.co → :3000
# ----------------------------------------
server {
    listen 80;
    server_name stage-artisans.telar.co;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name stage-artisans.telar.co;

    ssl_certificate     /etc/letsencrypt/live/stage-api.telar.co/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/stage-api.telar.co/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass         http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
}

# ----------------------------------------
# Marketplace Web (React) — stage-marketplace.telar.co → :3001
# ----------------------------------------
server {
    listen 80;
    server_name stage-marketplace.telar.co;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name stage-marketplace.telar.co;

    ssl_certificate     /etc/letsencrypt/live/stage-api.telar.co/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/stage-api.telar.co/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass         http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
}

# ----------------------------------------
# Agents (FastAPI) — stage-agents.telar.co → :8000
# ----------------------------------------
server {
    listen 80;
    server_name stage-agents.telar.co;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name stage-agents.telar.co;

    ssl_certificate     /etc/letsencrypt/live/stage-api.telar.co/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/stage-api.telar.co/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass         http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
        proxy_read_timeout 120s;
    }
}

# ----------------------------------------
# Payment Service (Go) — stage-payment.telar.co → :8090
# ----------------------------------------
server {
    listen 80;
    server_name stage-payment.telar.co;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name stage-payment.telar.co;

    ssl_certificate     /etc/letsencrypt/live/stage-api.telar.co/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/stage-api.telar.co/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        proxy_pass         http://127.0.0.1:8090;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
}

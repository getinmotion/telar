# ========================================
# GetInMotion — Production Nginx Configuration
# Host-level reverse proxy (installed directly on the server, NOT in Docker)
#
# Prerequisites:
#   sudo apt install -y nginx certbot python3-certbot-nginx
#
# To install:
#   sudo cp nginx.conf /etc/nginx/sites-available/telar
#   sudo ln -s /etc/nginx/sites-available/telar /etc/nginx/sites-enabled/telar
#   sudo rm -f /etc/nginx/sites-enabled/default
#   sudo nginx -t && sudo systemctl reload nginx
#
# Then obtain SSL certs (DNS A records must already point to this server):
#   sudo certbot --nginx \
#     -d api.yourdomain.com \
#     -d artisans.yourdomain.com \
#     -d marketplace.yourdomain.com \
#     -d agents.yourdomain.com \
#     -d payment.yourdomain.com
#
# Replace every occurrence of "yourdomain.com" with your actual domain.
# ========================================

# ----------------------------------------
# API (NestJS) — api.yourdomain.com → :3040
# ----------------------------------------
server {
    listen 80;
    server_name api.yourdomain.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name api.yourdomain.com;

    # Certbot will insert ssl_certificate directives here
    # ssl_certificate     /etc/letsencrypt/live/api.yourdomain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/api.yourdomain.com/privkey.pem;

    location / {
        proxy_pass         http://127.0.0.1:3040;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
        proxy_read_timeout 60s;
    }
}

# ----------------------------------------
# Artisans Web (React) — artisans.yourdomain.com → :3000
# ----------------------------------------
server {
    listen 80;
    server_name artisans.yourdomain.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name artisans.yourdomain.com;

    # ssl_certificate     /etc/letsencrypt/live/artisans.yourdomain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/artisans.yourdomain.com/privkey.pem;

    location / {
        proxy_pass         http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
}

# ----------------------------------------
# Marketplace Web (React) — marketplace.yourdomain.com → :3001
# ----------------------------------------
server {
    listen 80;
    server_name marketplace.yourdomain.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name marketplace.yourdomain.com;

    # ssl_certificate     /etc/letsencrypt/live/marketplace.yourdomain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/marketplace.yourdomain.com/privkey.pem;

    location / {
        proxy_pass         http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
}

# ----------------------------------------
# Agents (FastAPI) — agents.yourdomain.com → :8000
# ----------------------------------------
server {
    listen 80;
    server_name agents.yourdomain.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name agents.yourdomain.com;

    # ssl_certificate     /etc/letsencrypt/live/agents.yourdomain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/agents.yourdomain.com/privkey.pem;

    location / {
        proxy_pass         http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
        proxy_read_timeout 120s;
    }
}

# ----------------------------------------
# Payment Service (Go) — payment.yourdomain.com → :8090
# ----------------------------------------
server {
    listen 80;
    server_name payment.yourdomain.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name payment.yourdomain.com;

    # ssl_certificate     /etc/letsencrypt/live/payment.yourdomain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/payment.yourdomain.com/privkey.pem;

    location / {
        proxy_pass         http://127.0.0.1:8090;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
}

name: Build & Push Images to GHCR (Production)

on:
  push:
    branches:
      - main
    paths:
      - 'apps/api/**'
      - 'apps/agents/**'
      - 'apps/src/**'
      - 'apps/artisans-web/**'
      - 'apps/marketplace-web/**'
      - 'apps/payment-svc/**'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to build (api | agents | artisans-web | marketplace-web | payment-svc | all)'
        required: false
        default: 'all'

env:
  REGISTRY: ghcr.io
  IMAGE_OWNER: ${{ github.repository_owner }}

jobs:
  # ============================================================
  # Detect which services changed to avoid unnecessary builds
  # ============================================================
  changes:
    name: Detect changed services
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      agents: ${{ steps.filter.outputs.agents }}
      artisans-web: ${{ steps.filter.outputs.artisans-web }}
      marketplace-web: ${{ steps.filter.outputs.marketplace-web }}
      payment-svc: ${{ steps.filter.outputs.payment-svc }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'apps/api/**'
            agents:
              - 'apps/agents/**'
              - 'apps/src/**'
            artisans-web:
              - 'apps/artisans-web/**'
            marketplace-web:
              - 'apps/marketplace-web/**'
            payment-svc:
              - 'apps/payment-svc/**'

  # ============================================================
  # API — NestJS
  # ============================================================
  build-api:
    name: Build API (NestJS)
    needs: changes
    if: |
      needs.changes.outputs.api == 'true' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.service == 'api' || github.event.inputs.service == 'all'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.IMAGE_OWNER }}/gim-api
          tags: |
            type=raw,value=main
            type=sha,prefix=sha-,format=short

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: apps/api
          file: apps/api/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=gim-api-prod
          cache-to: type=gha,scope=gim-api-prod,mode=max

  # ============================================================
  # Agents — Python / FastAPI
  # ============================================================
  build-agents:
    name: Build Agents (Python/FastAPI)
    needs: changes
    if: |
      needs.changes.outputs.agents == 'true' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.service == 'agents' || github.event.inputs.service == 'all'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.IMAGE_OWNER }}/gim-agents
          tags: |
            type=raw,value=main
            type=sha,prefix=sha-,format=short

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: apps
          file: apps/agents/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=gim-agents-prod
          cache-to: type=gha,scope=gim-agents-prod,mode=max

  # ============================================================
  # Artisans Web — Vite / React
  # VITE_* vars baked into image at build time from PROD_* secrets
  # ============================================================
  build-artisans-web:
    name: Build Artisans Web (Vite/React)
    needs: changes
    if: |
      needs.changes.outputs['artisans-web'] == 'true' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.service == 'artisans-web' || github.event.inputs.service == 'all'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.IMAGE_OWNER }}/gim-artisans-web
          tags: |
            type=raw,value=main
            type=sha,prefix=sha-,format=short

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: apps/artisans-web
          file: apps/artisans-web/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VITE_SUPABASE_URL=${{ secrets.PROD_VITE_SUPABASE_URL }}
            VITE_SUPABASE_PUBLISHABLE_KEY=${{ secrets.PROD_VITE_SUPABASE_PUBLISHABLE_KEY }}
            VITE_SUPABASE_ANON_KEY=${{ secrets.PROD_VITE_SUPABASE_ANON_KEY }}
            VITE_BACKEND_URL=${{ secrets.PROD_VITE_BACKEND_URL }}
            VITE_SEMANTIC_SEARCH_URL=${{ secrets.PROD_VITE_SEMANTIC_SEARCH_URL }}
            VITE_SEMANTIC_SEARCH_API_KEY=${{ secrets.PROD_VITE_SEMANTIC_SEARCH_API_KEY }}
            VITE_GOOGLE_PLACES_API_KEY=${{ secrets.PROD_VITE_GOOGLE_PLACES_API_KEY }}
          cache-from: type=gha,scope=gim-artisans-web-prod
          cache-to: type=gha,scope=gim-artisans-web-prod,mode=max

  # ============================================================
  # Marketplace Web — Vite / React
  # VITE_* vars baked into image at build time from PROD_* secrets
  # ============================================================
  build-marketplace-web:
    name: Build Marketplace Web (Vite/React)
    needs: changes
    if: |
      needs.changes.outputs['marketplace-web'] == 'true' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.service == 'marketplace-web' || github.event.inputs.service == 'all'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.IMAGE_OWNER }}/gim-marketplace-web
          tags: |
            type=raw,value=main
            type=sha,prefix=sha-,format=short

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: apps/marketplace-web
          file: apps/marketplace-web/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VITE_SUPABASE_URL=${{ secrets.PROD_MARKETPLACE_VITE_SUPABASE_URL }}
            VITE_SUPABASE_PUBLISHABLE_KEY=${{ secrets.PROD_MARKETPLACE_VITE_SUPABASE_PUBLISHABLE_KEY }}
            VITE_SEMANTIC_SEARCH_API_URL=${{ secrets.PROD_MARKETPLACE_VITE_SEMANTIC_SEARCH_API_URL }}
            VITE_SEMANTIC_SEARCH_API_KEY=${{ secrets.PROD_MARKETPLACE_VITE_SEMANTIC_SEARCH_API_KEY }}
            VITE_BACKEND_URL=${{ secrets.PROD_VITE_BACKEND_URL }}
          cache-from: type=gha,scope=gim-marketplace-web-prod
          cache-to: type=gha,scope=gim-marketplace-web-prod,mode=max

  # ============================================================
  # Payment Service — Go
  # ============================================================
  build-payment-svc:
    name: Build Payment Service (Go)
    needs: changes
    if: |
      needs.changes.outputs['payment-svc'] == 'true' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.service == 'payment-svc' || github.event.inputs.service == 'all'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.IMAGE_OWNER }}/gim-payment-svc
          tags: |
            type=raw,value=main
            type=sha,prefix=sha-,format=short

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: apps/payment-svc
          file: apps/payment-svc/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=gim-payment-svc-prod
          cache-to: type=gha,scope=gim-payment-svc-prod,mode=max

  # ============================================================
  # Deploy to Production
  # Requires manual approval via GitHub Environment "production"
  # Set up: Repository → Settings → Environments → production → Required Reviewers
  # ============================================================
  deploy-prod:
    name: Deploy to Production
    needs: [build-api, build-agents, build-artisans-web, build-marketplace-web, build-payment-svc]
    if: always() && !failure() && !cancelled()
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: SSH deploy to production
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_PROD_HOST }}
          username: ${{ secrets.SSH_PROD_USER }}
          key: ${{ secrets.SSH_PROD_KEY }}
          script: |
            cd ~/telar/infra/prod
            git pull origin main
            docker compose pull
            docker compose up -d --remove-orphans
